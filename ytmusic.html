<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Music</title>
    <link rel="icon" type="image/png" href="images/music.png">
    <link rel="shortcut icon" href="images/music.png" type="image/x-icon" />
    <link rel="apple-touch-icon" href="images/music.png" />      
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@300;500;700&display=swap');

        :root {
            --neon-purple: #9d00ff;
            --neon-blue: #00d4ff;
            --bg-dark: #0a0a0c;
        }

        body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            font-family: 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
        }

        .font-tech { font-family: 'Orbitron', sans-serif; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-purple); }

        .glass-panel {
            background: rgba(20, 20, 25, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .active-song {
            background: linear-gradient(90deg, rgba(157, 0, 255, 0.2) 0%, rgba(0, 212, 255, 0.1) 100%);
            border-left: 4px solid var(--neon-purple);
        }

        .neon-text-purple { text-shadow: 0 0 10px var(--neon-purple); }

        .video-mode-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #000;
            border-radius: 1rem;
            overflow: hidden;
        }

        #youtube-player-container {
            width: 100%;
            height: 100%;
        }

        .hidden-player {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 10px;
            height: 10px;
            opacity: 0;
        }

        .custom-select {
            background: #1f2937; 
            border: 1px solid rgba(157, 0, 255, 0.6);
            color: #ffffff;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border-radius: 9999px;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239d00ff'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            font-weight: 600;
        }
        
        .custom-select option {
            background-color: #111827;
            color: #ffffff;
        }

        .animate-spin-slow {
            animation: spin 8s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .progress-bar-transition {
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- 頂部導航 -->
    <nav class="p-4 glass-panel sticky top-0 z-50 flex justify-between items-center px-6">
        <div class="flex items-center gap-2">
            <!-- <i class="fab fa-youtube text-red-600 text-3xl"></i> -->
			<div onclick="window.location='index.html'"><img src="./images/home2.png" width="20px" style="cursor:pointer;"></div>
			<span class="text-xl font-tech font-bold tracking-tighter neon-text-purple uppercase hidden sm:inline">Cyber Music</span>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <i class="fas fa-list-ul text-purple-400 text-sm"></i>
                <select id="playlist-dropdown" class="custom-select text-sm shadow-lg">
                    <option value="">快速跳轉清單...</option>
                </select>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <main class="flex-grow p-4 md:p-8 flex flex-col lg:flex-row gap-8 mb-32">
        
        <!-- 左側：清單展示 -->
        <div class="w-full lg:w-2/3 space-y-8 order-2 lg:order-1">
            <div id="playlists-container" class="space-y-12">
                <div class="animate-pulse text-gray-500 font-tech uppercase">Syncing Data Streams...</div>
            </div>
        </div>

        <!-- 右側：播放控制核心 -->
        <div class="w-full lg:w-1/3 order-1 lg:order-2">
            <div class="glass-panel rounded-3xl p-6 sticky top-24 border border-purple-500/20 shadow-2xl">
                
                <!-- 模式切換器 -->
                <div id="modeSwitch" class="flex justify-center mb-6">
                    <div class="bg-black/40 p-1 rounded-full flex items-center gap-1 border border-white/5">
                        <button id="mode-audio" class="px-6 py-1.5 rounded-full text-xs font-bold transition duration-300 bg-purple-600 text-white shadow-lg">
                            <i class="fas fa-music mr-2"></i>音訊
                        </button>
                        <button id="mode-video" class="px-6 py-1.5 rounded-full text-xs font-bold transition duration-300 text-gray-400 hover:text-white">
                            <i class="fas fa-video mr-2"></i>影片
                        </button>
                    </div>
                </div>
                
                <!-- 內容顯示 -->
                <div id="player-display-area" class="relative">
                    <!-- 音訊模式封面 -->
                    <div id="display-audio" class="text-center py-4">
                        <div class="relative inline-block mb-6">
                            <div id="glow-effect" class="absolute inset-0 bg-purple-600 blur-[60px] opacity-20 rounded-full transition-all duration-1000"></div>
                            <div id="thumb-wrapper" class="w-64 h-64 rounded-2xl shadow-2xl mx-auto relative z-10 border-2 border-white/10 overflow-hidden bg-zinc-900 flex items-center justify-center">
                                <img id="current-thumb" src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=500&auto=format&fit=crop" class="w-full h-full object-cover" alt="Cover">
                            </div>
                        </div>
                    </div>

                    <!-- 影片容器 -->
                    <div id="display-video" class="video-mode-container hidden mb-6 shadow-2xl border border-white/10">
                        <div id="youtube-player-container"></div>
                    </div>
                </div>

                <div class="text-center mb-6">
                    <h2 id="current-title" class="text-xl font-bold truncate px-4">請選擇歌曲</h2>
                    <p id="current-artist" class="text-purple-400 mt-1 font-medium font-tech">SYSTEM READY</p>
                </div>

                <!-- 當前隊列 -->
                <div class="border-t border-white/5 pt-4">
                    <h3 class="text-[10px] font-tech text-gray-500 uppercase tracking-widest mb-3 px-2">Next In Queue</h3>
                    <div id="queue-container" class="max-h-[25vh] overflow-y-auto space-y-1 pr-2 custom-scrollbar"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- 底部控制面板 -->
    <div class="fixed bottom-0 left-0 w-full glass-panel border-t border-white/10 p-4 pb-6 z-50">
        <!-- 進度條 -->
        <div class="progress-container w-full px-4 mb-4">
            <div class="flex justify-between text-[10px] font-tech text-gray-400 mb-1">
                <span id="time-current">0:00</span>
                <span id="time-total">0:00</span>
            </div>
            <div id="progress-bg" class="w-full bg-white/10 rounded-full h-1.5 cursor-pointer">
                <div id="progress-fill" class="h-full w-0 bg-gradient-to-r from-purple-600 to-cyan-400 progress-bar-transition relative"></div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
            <!-- 迷你歌曲資訊 -->
            <div class="hidden sm:flex items-center gap-4 w-1/4">
                <img id="mini-thumb" src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=100&auto=format&fit=crop" class="w-12 h-12 rounded-lg object-cover shadow-lg">
                <div class="truncate">
                    <div id="mini-title" class="font-bold text-sm truncate">IDLE</div>
                    <div id="mini-artist" class="text-xs text-gray-500 truncate">-</div>
                </div>
            </div>

            <!-- 主控制按鈕 -->
            <div class="flex flex-col items-center gap-2 flex-grow sm:flex-grow-0">
                <div class="flex items-center gap-6 md:gap-8">
                    <button id="btn-shuffle" class="text-gray-500 hover:text-purple-400 transition text-2xl" title="隨機播放">
                        <i class="fas fa-random"></i>
                    </button>
                    <button id="btn-prev" class="text-white hover:text-purple-400 transition text-2xl">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button id="btn-play-pause" class="w-14 h-14 bg-white text-black rounded-full flex items-center justify-center hover:scale-110 active:scale-95 transition">
                        <i class="fas fa-play text-xl ml-1" id="play-icon"></i>
                    </button>
                    <button id="btn-next" class="text-white hover:text-purple-400 transition text-2xl">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button id="btn-repeat" class="text-gray-500 hover:text-purple-400 transition text-2xl relative" title="重複播放模式">
                        <i class="fas fa-redo"></i>
                        <span id="repeat-one-tag" class="hidden absolute -top-1 -right-1 bg-purple-600 text-[8px] w-3 h-3 rounded-full flex items-center justify-center">1</span>
                    </button>
                </div>
            </div>

            <!-- 音量控制 -->
            <div class="hidden sm:flex items-center justify-end gap-4 w-1/4">
                <button id="btn-mute">
                    <i id="volume-icon" class="fas fa-volume-up text-gray-400 hover:text-white transition"></i>
                </button>
                <input type="range" id="volume-slider" min="0" max="100" value="80" class="w-24 accent-purple-500 h-1 cursor-pointer">
            </div>
        </div>
    </div>

    <!-- YouTube 實體隱藏存放區 -->
    <div id="player-hidden-box" class="hidden-player">
        <div id="youtube-player"></div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player;
        let currentPlaylist = [];
        let currentIndex = -1;
        let isShuffle = false;
        let repeatMode = 0; // 0: 不重複, 1: 全部循環, 2: 單曲循環
        let allMusicData = [];
        let isVideoMode = false;
        let isApiReady = false;
        const isMobile = () => window.innerWidth <= 768;

        async function loadMusicData() {
            try {
                const response = await fetch('./js/musics_data.json');
                const data = await response.json();
                allMusicData = data;
                renderPlaylists(data);
                populateDropdown(data);

                playSongFromList(0, 0);

            } catch (error) {
                console.error("Fetch Error:", error);
            }
        }

        function populateDropdown(data) {
            const dropdown = document.getElementById('playlist-dropdown');
            data.forEach((listObj, idx) => {
                const listName = Object.keys(listObj)[0];
                const option = document.createElement('option');
                option.value = `list-section-${idx}`;
                option.textContent = listName;
                dropdown.appendChild(option);
            });
            dropdown.addEventListener('change', (e) => {
                const target = document.getElementById(e.target.value);
                if (target) {
                    const navHeight = document.querySelector('nav').offsetHeight;
                    window.scrollTo({ top: target.offsetTop - navHeight - 20, behavior: 'smooth' });
                }
            });
        }

        function renderPlaylists(data) {
            const container = document.getElementById('playlists-container');
            container.innerHTML = '';
            data.forEach((listObj, listIndex) => {
                const listName = Object.keys(listObj)[0];
                const songs = listObj[listName];
                const section = document.createElement('section');
                section.id = `list-section-${listIndex}`;
                section.innerHTML = `
                    <h2 class="text-2xl font-tech font-bold mb-6 tracking-tight"><span class="text-purple-500">/</span> ${listName}</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-5 gap-6">
                        ${songs.map((song, idx) => `
                            <div class="playlist-card group bg-white/5 p-4 rounded-3xl cursor-pointer hover:bg-white/10 transition border border-transparent hover:border-purple-500/20" 
                                 onclick="playSongFromList(${listIndex}, ${idx})">
                                <div class="relative overflow-hidden rounded-2xl aspect-square mb-4">
                                    <img src="https://img.youtube.com/vi/${song.id}/hqdefault.jpg" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition">
                                        <i class="fas fa-play text-white text-2xl"></i>
                                    </div>
                                </div>
                                <div class="font-bold text-sm truncate group-hover:text-purple-400 transition">${song.title}</div>
                                <div class="text-xs text-gray-500 truncate">${song.artist}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                playerVars: { 
                    'autoplay': 0, 
                    'controls': 1, 
                    'rel': 0, 
                    'modestbranding': 1,
                    'playsinline': 1,
                    'origin': window.location.origin 
                },
                events: {
                    'onReady': (event) => { 
                        isApiReady = true; 
                        loadMusicData(); 
                        updateProgress(); 
                    },
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerStateChange(event) {
            const icon = document.getElementById('play-icon');
            
            // 處理播放狀態圖示
            if (event.data === YT.PlayerState.PLAYING) {
                icon.className = 'fas fa-pause text-xl';
                document.getElementById('glow-effect').style.opacity = '0.4';
                updateMediaSession();
            } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.BUFFERING) {
                icon.className = 'fas fa-play text-xl ml-1';
            }

            // 核心修正：當影片結束時自動播放下一首
            if (event.data === YT.PlayerState.ENDED) {
                handleAutoNext();
            }
        }

        function handleAutoNext() {
            if (repeatMode === 2) {
                // 單曲循環
                player.playVideo();
            } else if (isShuffle) {
                // 隨機播放
                currentIndex = Math.floor(Math.random() * currentPlaylist.length);
                loadAndPlay();
            } else {
                // 清單循環
                if (repeatMode === 1 || currentIndex < currentPlaylist.length - 1) {
                    currentIndex = (currentIndex + 1) % currentPlaylist.length;
                    loadAndPlay();
                } else {
                    // 結束清單且無循環模式
                    console.log("Playlist ended.");
                }
            }
        }

        function setMode(videoMode) {
            if (isVideoMode === videoMode) return;
            
            const wasPlaying = player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING;
            const currentTime = player && player.getCurrentTime ? player.getCurrentTime() : 0;
            const currentVideoId = currentPlaylist[currentIndex]?.id;

            isVideoMode = videoMode;
            const ytPlayer = document.getElementById('youtube-player');
            
            if (videoMode) {
                document.getElementById('mode-video').className = "px-6 py-1.5 rounded-full text-xs font-bold bg-purple-600 text-white shadow-lg";
                document.getElementById('mode-audio').className = "px-6 py-1.5 rounded-full text-xs font-bold text-gray-400 hover:text-white";
                document.getElementById('display-audio').classList.add('hidden');
                document.getElementById('display-video').classList.remove('hidden');
                document.getElementById('youtube-player-container').appendChild(ytPlayer);
            } else {
                document.getElementById('mode-audio').className = "px-6 py-1.5 rounded-full text-xs font-bold bg-purple-600 text-white shadow-lg";
                document.getElementById('mode-video').className = "px-6 py-1.5 rounded-full text-xs font-bold text-gray-400 hover:text-white";
                document.getElementById('display-audio').classList.remove('hidden');
                document.getElementById('display-video').classList.add('hidden');
                document.getElementById('player-hidden-box').appendChild(ytPlayer);
            }

            // 重新連結播放器狀態
            if (currentVideoId) {
                setTimeout(() => {
                    if (wasPlaying) {
                        player.loadVideoById({ 'videoId': currentVideoId, 'startSeconds': currentTime });
                    } else {
                        player.cueVideoById({ 'videoId': currentVideoId, 'startSeconds': currentTime });
                    }
                }, 300); 
            }
        }


        if (isMobile()){
            document.getElementById("modeSwitch").innerHTML = "";
        } else {
            document.getElementById('mode-audio').onclick = () => setMode(false);
            document.getElementById('mode-video').onclick = () => setMode(true);
        }


        function playSongFromList(lIdx, sIdx) {
            const listName = Object.keys(allMusicData[lIdx])[0];
            currentPlaylist = allMusicData[lIdx][listName];
            currentIndex = sIdx;
            renderQueue();
            loadAndPlay();
        }

        function loadAndPlay() {
            if (!isApiReady || currentIndex === -1) return;
            const song = currentPlaylist[currentIndex];
            player.loadVideoById(song.id);
            updateUI(song);
        }

        function updateUI(song) {
            document.getElementById('current-title').innerText = song.title;
            document.getElementById('current-artist').innerText = song.artist;
            document.getElementById('current-thumb').src = `https://img.youtube.com/vi/${song.id}/maxresdefault.jpg`;
            document.getElementById('mini-title').innerText = song.title;
            document.getElementById('mini-artist').innerText = song.artist;
            document.getElementById('mini-thumb').src = `https://img.youtube.com/vi/${song.id}/default.jpg`;

            // 更新隊列高亮
            document.querySelectorAll('.queue-item').forEach((el, idx) => {
                el.classList.toggle('active-song', idx === currentIndex);
            });

            // 自動滾動隊列到當前歌曲
            var activeItem;
            activeItem = document.querySelector('.active-song');
            if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            if (isMobile()){
                activeItem = document.getElementById('player-display-area');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } 
        }

        function renderQueue() {
            const container = document.getElementById('queue-container');
            container.innerHTML = currentPlaylist.map((song, idx) => `
                <div class="queue-item p-3 flex items-center gap-3 rounded-2xl cursor-pointer hover:bg-white/5 transition-all ${idx === currentIndex ? 'active-song' : ''}"
                     onclick="currentIndex=${idx}; loadAndPlay();">
                    <img src="https://img.youtube.com/vi/${song.id}/default.jpg" class="w-10 h-10 rounded-lg object-cover">
                    <div class="truncate flex-grow">
                        <div class="text-sm font-bold truncate">${song.title}</div>
                        <div class="text-[10px] text-gray-500 uppercase">${song.artist}</div>
                    </div>
                </div>
            `).join('');
        }

        // 按鈕控制
        document.getElementById('btn-play-pause').onclick = () => {
            if (currentIndex === -1) return;
            const state = player.getPlayerState();
            state === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo();
        };

        document.getElementById('btn-next').onclick = () => {
            if (currentPlaylist.length === 0) return;
            if (isShuffle) {
                currentIndex = Math.floor(Math.random() * currentPlaylist.length);
            } else {
                currentIndex = (currentIndex + 1) % currentPlaylist.length;
            }
            loadAndPlay();
        };

        document.getElementById('btn-prev').onclick = () => {
            if (currentPlaylist.length === 0) return;
            currentIndex = (currentIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
            loadAndPlay();
        };

        document.getElementById('btn-shuffle').onclick = function() {
            isShuffle = !isShuffle;
            this.classList.toggle('text-purple-400', isShuffle);
        };

        document.getElementById('btn-repeat').onclick = function() {
            repeatMode = (repeatMode + 1) % 3;
            this.classList.toggle('text-purple-400', repeatMode > 0);
            document.getElementById('repeat-one-tag').classList.toggle('hidden', repeatMode !== 2);
        };

        document.getElementById('volume-slider').oninput = (e) => player.setVolume(e.target.value);
        
        document.getElementById('btn-mute').onclick = () => {
            if (player.isMuted()) {
                player.unMute();
                document.getElementById('volume-icon').className = 'fas fa-volume-up text-gray-400';
            } else {
                player.mute();
                document.getElementById('volume-icon').className = 'fas fa-volume-mute text-purple-500';
            }
        };

        function updateProgress() {
            if (player && player.getCurrentTime) {
                const cur = player.getCurrentTime();
                const tot = player.getDuration();
                if (tot > 0) {
                    const pct = (cur / tot) * 100;
                    document.getElementById('progress-fill').style.width = pct + '%';
                    document.getElementById('time-current').innerText = formatTime(cur);
                    document.getElementById('time-total').innerText = formatTime(tot);
                }
            }
            requestAnimationFrame(updateProgress);
        }

        document.getElementById('progress-bg').onclick = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            player.seekTo(pos * player.getDuration());
        };

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function updateMediaSession() {
            if ('mediaSession' in navigator && currentPlaylist[currentIndex]) {
                const s = currentPlaylist[currentIndex];
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: s.title,
                    artist: s.artist,
                    artwork: [
                        { src: `https://img.youtube.com/vi/${s.id}/maxresdefault.jpg`, sizes: '512x512', type: 'image/jpg' },
                        { src: `https://img.youtube.com/vi/${s.id}/hqdefault.jpg`, sizes: '480x360', type: 'image/jpg' }
                    ]
                });
                navigator.mediaSession.setActionHandler('play', () => player.playVideo());
                navigator.mediaSession.setActionHandler('pause', () => player.pauseVideo());
                navigator.mediaSession.setActionHandler('previoustrack', () => document.getElementById('btn-prev').click());
                navigator.mediaSession.setActionHandler('nexttrack', () => document.getElementById('btn-next').click());
            }
        }
    </script>
</body>
</html>